<script type="text/javascript">
    RED.nodes.registerType('chart-image',{
        category: 'function',
        color: '#81e3c9',
        defaults: {
            name: {value:''},
			    width: {value: 500},
    			height: {value: 300}
        },
        inputs:1,
        outputs:1,
        icon: 'font-awesome/fa-bar-chart-o',
        label: function() {
            return this.name || 'chart-image';
        },
        labelStyle: function() {
            return this.name?'node_label_italic':'';
        },
        oneditsave: function() {
            if (this.width === undefined) {
                $("#node-input-width").val(500);
            }
			if (this.height === undefined) {
                $("#node-input-height").val(300);
            }
        }
    });

</script>

<script type="text/html" data-template-name="chart-image">
    <div class="form-row">
        <label for="node-input-width" style="width:120px;"><i class="fa fa-arrows-h"></i> Chart Width</label>
        <input type="number" id="node-input-width" placeholder="500" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-height" style="width:120px;"><i class="fa fa-arrows-v"></i> Chart Height</label>
        <input type="number" id="node-input-height" placeholder="300" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-name" style="width:120px;"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/markdown" data-help-name="chart-image">
Generate a chart image buffer using Chart.js.

### Inputs

: payload (object) : Chart.js configuration object containing `type`, `data`, and `options` in `msg.payload`.
: width (number) : Optional pixel width override via `msg.width`.
: height (number) : Optional pixel height override via `msg.height`.
: plugins (array) : Optional custom plugins from `msg.plugins`, registered in addition to built-in plugins.
: options.chartBackgroundColor / options.chartBackgroundColour (string) : Optional canvas background color in `msg.payload.options.chartBackgroundColor` or `chartBackgroundColour`. If omitted, the canvas will be transparent.

### Outputs

1. Chart image
: payload (buffer) : Image buffer rendered from the Chart.js configuration.

### Details

- Renders a chart from `msg.payload` using Chart.js.
- If no `backgroundColor` or `borderColor` is defined for a dataset, a default palette of 32 colors is used (instead of Chart.js default).
- Canvas size can be overridden by `msg.width` and/or `msg.height`.
- To set a non-transparent canvas background, use `msg.payload.options.chartBackgroundColor` or `chartBackgroundColour` (both spellings supported).
- Built-in plugins: Legend, Title, Subtitle, Filler, Decimation.
- Additional plugins included: `chartjs-plugin-annotation`, `chartjs-plugin-datalabels` (disabled by default).
- Annotation plugin: add lines, boxes, points, etc. via `options.plugins.annotation`.
- Datalabels plugin: enabled only if `options.plugins.datalabels.display` is `true` (globally or per dataset).
- You can add custom plugins at runtime via `msg.plugins` (array of plugin objects).

#### Example: Canvas Background Color

```json
{
  "options": {
    "chartBackgroundColor": "white"
  }
}
```

#### Example: Annotation Plugin

```json
{
  "type": "bar",
  "data": {
    "labels": ["Jan", "Feb", "Mar"],
    "datasets": [{
      "label": "Sales",
      "data": [12, 19, 15]
    }]
  },
  "options": {
    "plugins": {
      "annotation": {
        "annotations": {
          "myImportantLine": {
            "type": "line",
            "yMin": 15,
            "yMax": 15,
            "borderColor": "red",
            "borderWidth": 2,
            "scaleID": "y"
          }
        }
      }
    }
  }
}
```

#### Example: Datalabels Plugin

```json
{
  "options": {
    "plugins": {
      "datalabels": {
        "display": true
      }
    }
  }
}
```

#### Example: Datalabels Per Dataset

```json
{
  "type": "bar",
  "data": {
    "labels": ["Jan", "Feb", "Mar"],
    "datasets": [{
      "label": "Sales",
      "data": [12, 19, 15],
      "datalabels": {
        "display": true
      }
    }]
  }
}
```

#### Example: Add Custom Plugins

```javascript
msg.plugins = [ myCustomPlugin ]; // Must be an array
```

### Examples

Bar chart

```json
{
  "type": "bar",
  "data": {
    "labels": ["One", "Two"],
    "datasets": [
      {
        "label": "Dataset",
        "data": [1, 2]
      }
    ]
  },
  "options": {
    "plugins": {
      "datalabels": {
        "display": true
      },
      "annotation": {
        "annotations": {}
      }
    }
  }
}
```

Line chart

```json
{
  "type": "line",
  "data": {
    "labels": ["Pt 1", "Pt 2", "Pt 3", "Pt 4"],
    "datasets": [
      {
        "label": "Sample",
        "data": [12, 19, 7, 15],
        "fill": false,
        "tension": 0,
        "pointRadius": 4,
        "borderWidth": 2
      }
    ]
  },
  "options": {
    "responsive": false,
    "plugins": {
      "title": {
        "display": true,
        "text": "Simple Line (4 points)"
      },
      "legend": {
        "display": true
      }
    },
    "scales": {
      "y": {
        "beginAtZero": true
      }
    }
  }
}
```

### Resources

- [Chart.js documentation](https://www.chartjs.org/docs/4.4.9/)
- [chartjs-node-canvas documentation](https://www.npmjs.com/package/chartjs-node-canvas)
- [chartjs-plugin-datalabels documentation](https://chartjs-plugin-datalabels.netlify.app/guide/)
- [chartjs-plugin-annotation](https://github.com/chartjs/chartjs-plugin-annotation#readme)
</script>
