<script type="text/javascript">
    RED.nodes.registerType('chart-image',{
        category: 'function',
        color: '#81e3c9',
        defaults: {
            name: {value:''},
			    width: {value: 500},
    			height: {value: 300}
        },
        inputs:1,
        outputs:1,
        icon: 'font-awesome/fa-bar-chart-o',
        label: function() {
            return this.name || 'chart-image';
        },
        labelStyle: function() {
            return this.name?'node_label_italic':'';
        },
        oneditsave: function() {
            if (this.width === undefined) {
                $("#node-input-width").val(500);
            }
			if (this.height === undefined) {
                $("#node-input-height").val(300);
            }
        }
    });

</script>

<script type="text/html" data-template-name="chart-image">
    <div class="form-row">
        <label for="node-input-width" style="width:120px;"><i class="fa fa-arrows-h"></i> Chart Width</label>
        <input type="number" id="node-input-width" placeholder="500" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-height" style="width:120px;"><i class="fa fa-arrows-v"></i> Chart Height</label>
        <input type="number" id="node-input-height" placeholder="300" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-name" style="width:120px;"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/markdown" data-help-name="chart-image">
Generate a Chart.js image buffer.

### Inputs

: payload (object) : Chart.js configuration containing `type`, `data`, and `options` in `msg.payload`.
: width (number)   : Optional pixel width override supplied by `msg.width`.
: height (number)  : Optional pixel height override supplied by `msg.height`.
: plugins (array)  : Optional custom plugins from `msg.plugins`, registered alongside datalabels and annotation plugins.
: options.backgroundColor (string) : Optional canvas background color in `msg.payload.options.backgroundColor`. If omitted, `msg.backgroundColour` / `msg.backgroundColor` are used as a fallback.

### Outputs

1. Chart image
: payload (buffer) : Image buffer rendered from the Chart.js configuration.

### Details

The node renders a chart from `msg.payload`, applies a default color palette when dataset colors are missing, respects `options.backgroundColor` for the canvas fill, and registers the datalabels plugin when `payload.options.plugins.datalabels.display` is `true`. Provide `msg.width` and `msg.height` to override the configured dimensions.

### Examples

Bar chart

```json
{
  "type": "bar",
  "data": {
    "labels": ["One", "Two"],
    "datasets": [
      {
        "label": "Dataset",
        "data": [1, 2]
      }
    ]
  },
  "options": {
    "plugins": {
      "datalabels": {
        "display": true
      },
      "annotation": {
        "annotations": {}
      }
    }
  }
}
```

Line chart

```json
{
  "type": "line",
  "data": {
    "labels": ["Pt 1", "Pt 2", "Pt 3", "Pt 4"],
    "datasets": [
      {
        "label": "Sample",
        "data": [12, 19, 7, 15],
        "fill": false,
        "tension": 0,
        "pointRadius": 4,
        "borderWidth": 2
      }
    ]
  },
  "options": {
    "responsive": false,
    "plugins": {
      "title": {
        "display": true,
        "text": "Simple Line (4 points)"
      },
      "legend": {
        "display": true
      }
    },
    "scales": {
      "y": {
        "beginAtZero": true
      }
    }
  }
}
```

### Resources

- [Chart.js documentation](https://www.chartjs.org/docs/latest/)
- [chartjs-node-canvas documentation](https://www.npmjs.com/package/chartjs-node-canvas)
- [chartjs-plugin-datalabels documentation](https://chartjs-plugin-datalabels.netlify.app/guide/)
</script>
